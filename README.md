# Google Remote Procedure Calls (gRPC) Playground

This __gRPC__ GitHub repository is used to analyze gRPC protocol with different scenario:

* localhost latency
* server-to-server latency
* server-to-server latency with encryption
* unary vs. both side streaming mode

Please note that, the size of protocol buffer messages, encryption and processing time on server and clients would impact the processing time. 
It is focused to evaluate the *minimum* for gRPC communication time. Consequently, the only processing time on the server and client side is the *timestamping*. 


## Create .proto artifacts

The Google Protocol buffer compiler *protoc* is used to create the Python programming languange specific Google procol buffer artifacts.

An *Order* of 33 - byte is used for the prototyping. An *OrderRely* consist of *9* byte. See *order.proto* file: 

``` python
message Order {
  int64 instrumentID = 1;
  int64 price = 2;
  int64 quantity = 3;
  bool side = 4;
  google.protobuf.Timestamp requestTime = 5;
}

message OrderReply {
  bool result = 1;
  google.protobuf.Timestamp responseTime = 2;
}
```

The corresponding Google protocol buffer Python artifacts are created by using:

``` shell
$ python3 -m grpc_tools.protoc -I. --grpc_python_out=. --python_out=. order.proto
```

The generated Google protocol buffer Python artifacts are:

``` shell
order_pb2.py
order_pb2_grcp.py
```

The *stream* approach for the communication between gRPC server and client is chosen in order to keep the *sending order* of the sending order messages. 

``` python
service OrderService {
  rpc AddOrder(stream Order) returns (stream OrderReply) {  }
}
```

## Certicate for encryption

The server cerificate is created by using *openssl* as follows:

``` shell
$ openssl genrsa -out server.key 2048
```

The private key is generated by using the *server.key*:

``` shell
$ openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:4096 -keyout server.key -out server.crt
```

The created certiciface can be verified by using *openssl -txt* command as follows:

``` shell
$ openssl x509 -in server.crt -text -noout
```

## Single gRPC Server
 
The single *gRPC server* runs with a threadpool with *10* workers (can be configured by passing an argument) to receive the incoming (order)messages. 
The gRPC server receives the sent orders with a *requestTime* timestamp by the gRPC clients and replies with a *Boolean* and a *responseTime* timestamp that the order is received.

```python
python3 grpc_server.py --help
```

## Single gRPC Client

The *gRPC client* sends an *Order* with a *requestTime* timestamp by using the Google protocol buffer to the single gRPC server.  

## Multiple gRPC Clients

The *multiple gRPC clients* is used to simulate several *gRPC clients*. All gRPC clients are started in parallell.  
All gRPC clients is based on the same logic. They simply send an Order with a *requestTime* timestamp to the gRPC server. 

### Localhost test results

The *single gRPC server* and *multiple gRPC clients* is based on *unary* and run on the same local server (AWS).

```shell
$ python3 grcp_clients.py --no-of-clients=100000 --count=1000000


Number of clients 100000 and number of order transactions 1000000
0 transactions and elapsed time 0.0016 in seconds
1000 transactions and elapsed time 0.2707 in seconds
2000 transactions and elapsed time 0.5320 in seconds
3000 transactions and elapsed time 0.7929 in seconds
4000 transactions and elapsed time 1.0512 in seconds
5000 transactions and elapsed time 1.3075 in seconds
6000 transactions and elapsed time 1.5661 in seconds
7000 transactions and elapsed time 1.8335 in seconds
8000 transactions and elapsed time 2.0970 in seconds
9000 transactions and elapsed time 2.3582 in seconds
10000 transactions and elapsed time 2.6195 in seconds
```

Several runs with different number of gRPC clients:

```shell
$ python3 grcp_clients.py --no-of-clients=1000 --count=1000
Number of clients 1000 and number of order transactions 1000
transactions and elapsed time 0.2859 in seconds
$ python3 grcp_clients.py --no-of-clients=1000 --count=10000
Number of clients 1000 and number of order transactions 10000
transactions and elapsed time 2.7039 in seconds
$ python3 grcp_clients.py --no-of-clients=1000 --count=100000
Number of clients 1000 and number of order transactions 100000
transactions and elapsed time 27.5429 in seconds
$ python3 grcp_clients.py --no-of-clients=10000 --count=100000
Number of clients 10000 and number of order transactions 100000
transactions and elapsed time 27.7686 in seconds
```

### Server to Server test results

The *gRPC server* and *multiple gRPC clients* is based on *unary* and run on the different server (AWS - Red Hat 7).

```shell
$ python3 grcp_clients.py --no-of-clients=1000 --count=1000
Number of clients 1000 and number of order transactions 1000
transactions and elapsed time 1.4660 in seconds
$ python3 grcp_clients.py --no-of-clients=1000 --count=10000
Number of clients 1000 and number of order transactions 10000
transactions and elapsed time 17.7699 in seconds
$ python3 grcp_clients.py --no-of-clients=1000 --count=100000
Number of clients 1000 and number of order transactions 100000
transactions and elapsed time 166.9796 in seconds
$ python3 grcp_clients.py --no-of-clients=5000 --count=10000
Number of clients 5000 and number of order transactions 10000
transactions and elapsed time 14.2598 in seconds
$ python3 grcp_clients.py --no-of-clients=10000 --count=10000
Number of clients 10000 and number of order transactions 10000
transactions and elapsed time 17.6165 in seconds
$ python3 grcp_clients.py --no-of-clients=20000 --count=10000
Number of clients 20000 and number of order transactions 10000
transactions and elapsed time 17.2865 in seconds

```

### localhost test results with both side streaming 

The *gRPC server* and *multiple 10.000 gRPC clients* use both side *streaming* (server and client) and run on a local server (AWS - Red Hat 7). Each *gRPC clients* sends *1000* orders:

```shell
$ python3 grpc_clients.py --no-of-clients=10000 --count=1000

2022-07-15 11:23:51,470 | gRPC_playground | 43 | INFO | Number of clients 10000 and number of order transactions 1000
2022-07-15 11:23:52,110 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6352 in seconds
Elapsed time 0.6353 in seconds
2022-07-15 11:23:52,741 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6305 in seconds
Elapsed time 0.6306 in seconds
2022-07-15 11:23:53,371 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6295 in seconds
Elapsed time 0.6296 in seconds
2022-07-15 11:23:53,979 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6071 in seconds
Elapsed time 0.6072 in seconds
2022-07-15 11:23:54,598 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6176 in seconds
Elapsed time 0.6177 in seconds
2022-07-15 11:23:55,275 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6767 in seconds
Elapsed time 0.6768 in seconds
2022-07-15 11:23:55,969 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6938 in seconds
Elapsed time 0.6939 in seconds
2022-07-15 11:23:56,590 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6201 in seconds
Elapsed time 0.6201 in seconds
2022-07-15 11:23:57,209 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6179 in seconds
Elapsed time 0.6180 in seconds
2022-07-15 11:23:57,824 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6148 in seconds
Elapsed time 0.6149 in seconds
2022-07-15 11:23:58,508 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6830 in seconds
Elapsed time 0.6832 in seconds
2022-07-15 11:23:59,125 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6168 in seconds
Elapsed time 0.6169 in seconds
2022-07-15 11:23:59,742 | gRPC_playground | 141 | INFO | 1000 transactions and elapsed time 0.6162 in seconds
Elapsed time 0.6163 in seconds

...

```

gRPC in *streaming* mode consumes more time compare to the *unary* mode, i.e, in avarage *0.6* seconds vs *0.25* seconds for 1000 order messages on a local server. 
In other words, the both side *streaming* mode is at least twice slower than the *unary* mode.